name: Terraform Security Scan

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'terraform_code/**'
      - '.github/workflows/terraform-security.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'terraform_code/**'
      - '.github/workflows/terraform-security.yml'
  workflow_dispatch:

jobs:
  tfsec:
    name: TFSec Security Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run TFSec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform_code
          soft_fail: true
          format: lovely

      - name: Run TFSec with SARIF Output
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: terraform_code
          soft_fail: true
          format: sarif
          sarif_file: tfsec-results.sarif

      - name: Upload SARIF Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
        continue-on-error: true

  checkov:
    name: Checkov Policy Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform_code
          framework: terraform
          soft_fail: true
          output_format: cli
          download_external_modules: false
          skip_check: CKV_AWS_144,CKV_AWS_145,CKV2_AWS_62

      - name: Run Checkov with SARIF Output
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform_code
          framework: terraform
          soft_fail: true
          output_format: sarif
          output_file_path: checkov-results.sarif
          download_external_modules: false
          skip_check: CKV_AWS_144,CKV_AWS_145,CKV2_AWS_62
        continue-on-error: true

      - name: Upload Checkov SARIF Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  trivy:
    name: Trivy IaC Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run Trivy Scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: 'terraform_code'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Run Trivy with SARIF Output
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'config'
          scan-ref: 'terraform_code'
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Upload Trivy SARIF Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif
        continue-on-error: true

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [tfsec, checkov, trivy]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scanner | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| TFSec | ${{ needs.tfsec.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Checkov | ${{ needs.checkov.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy | ${{ needs.trivy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Note: Security scans are set to soft-fail for informational purposes." >> $GITHUB_STEP_SUMMARY
          echo "Review findings in the Security tab or workflow logs." >> $GITHUB_STEP_SUMMARY
